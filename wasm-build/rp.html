<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>EL PASSO Relying Party (RP) Demo</title>
</head>

<body>
  <h3>EL PASSO Relying Party (RP): For demo purpose only</h3>
  <h4 id='rp-name-title'>Service Name: </h4>
  <p>
    Note: This demo is only for the purpose of showing how WASM ELPASSO RP
    works.
    <br />
    Author: Zhiyi Zhang (zhiyi@cs.ucla.edu)
  </p>

  <hr />

  <h4>Step 0: RP Setup</h4>
  <p>
    Please copy paste the IdP's public key here and give the RP a name to set up the RP.
  </p>
  <textarea id="idp-pk" rows="5" cols="50"></textarea>
  <br />
  <input id="rp-name" />
  <br />
  <button type="button" onclick="init()" value="0">Setup RP</button>
  <br />
  <p id="rp-init-result" style="width: 600px; overflow-wrap: break-word"></p>

  <hr />

  <h4>Step 1: Authenticate User</h4>
  <p>
    Please copy paste the sign on request generated by the user.
  </p>
  <textarea id="user-request" rows="5" cols="50"></textarea>
  <br />
  <button type="button" onclick="authenticate(); start() " >Authenticate User</button>
  <p id="authenticate-result" style="width: 600px; overflow-wrap: break-word"></p>
  <div class="circle">
        <span class="time" id="display">00:00:00</span>
      </div>
  <p id="check"></p>
  <script>
  function timeToString(time) {
  let diffInHrs = time / 3600000;
  let hh = Math.floor(diffInHrs);

  let diffInMin = (diffInHrs - hh) * 60;
  let mm = Math.floor(diffInMin);

  let diffInSec = (diffInMin - mm) * 60;
  let ss = Math.floor(diffInSec);

  let diffInMs = (diffInSec - ss) * 100;
  let ms = Math.floor(diffInMs);

  let formattedMM = mm.toString().padStart(2, "0");
  let formattedSS = ss.toString().padStart(2, "0");
  let formattedMS = ms.toString().padStart(2, "0");

  return `${formattedMM}:${formattedSS}:${formattedMS}`;
}
let startTime;
let elapsedTime = 0;
let timerInterval;
let stopTime = 0 ;
let j;
// Create function to modify innerHTML

function print(txt) {
  document.getElementById("display").innerHTML = txt;
}

// Create "start", "pause" and "reset" functions

function start() {
  startTime = Date.now() - elapsedTime;
  timerInterval = setInterval(function printTime() {
    elapsedTime = Date.now() - startTime;
    
    print(timeToString(elapsedTime));
  }, 10);
  
}

console.log(timerInterval);
function pause() {
  clearInterval(timerInterval);
}

    var Module = {
      onRuntimeInitialized: function () {
        Module.initPairing();
        console.log("init pairing");
      },
    };
    document.getElementById("idp-pk").value = "";

    var rp;
    var rp_name;
    var assoData = "demo_only";

    function init() {
      rp_name = document.getElementById("rp-name").value;
      document.getElementById("rp-name-title").innerHTML = "Service Name: " + rp_name;
      var keyBase64 = document.getElementById("idp-pk").value;
      if (keyBase64.length == 0) {
        alert("Empty IdP's public key is detected.");
        return;
      }
      var pk = Module.PSPubKey.fromBufferString(Module.PSBuffer.fromBase64(keyBase64));
      rp = new Module.PSVerifier(pk);
      console.log("init RP");
      document.getElementById("rp-init-result").innerHTML = "Succeed!";
    }

    function authenticate() {
      var requestBase64 = document.getElementById("user-request").value;
      var request = Module.IdProof.fromBufferString(Module.PSBuffer.fromBase64(requestBase64));
      var doesSucceed = rp.el_passo_verify_id_without_id_retrieval(request, assoData, rp_name);
      var userId = Module.PSVerifier.get_user_name_from_signon_request(request);
      //userId = userId.replaceAll(" ", "");
      if (doesSucceed) {
      		
      		
		let v = stopTime
		document.getElementById("check").innerHTML = v;
      
        	document.getElementById("authenticate-result").innerHTML = "User's sign on request is valid! <br />" + "User ID: <br />" + userId;
        	console.log(elapsedTime);
        }
        	
      else {
      	console.log(elapsedTime);
      	document.getElementById("authenticate-result").innerHTML = "User's sign on request is invalid!";
      }
    }
  </script>
  <script async src="el-passo-rp.js"></script>
 
</body>

</html>
